<div class="space-y-6">
  <.page_header
    title="Settings"
    description="Configure API keys, integrations, and scheduling"
  />

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Settings Column -->
    <div class="lg:col-span-2 space-y-6">
      <!-- API Keys Section -->
      <.card>
        <:header>
          <.card_header
            icon="key"
            title="API Keys"
            description="Configure external service credentials"
          />
        </:header>

        <form phx-submit="save_api_keys" phx-change="validate_api" class="space-y-5">
          <!-- Anthropic -->
          <div>
            <div class="flex items-center justify-between mb-1.5">
              <label class="label-enterprise mb-0">Anthropic API Key (Claude)</label>
              <span :if={@api_form.params["anthropic_configured"]} class="badge-success">Active</span>
            </div>
            <p :if={@api_form.params["anthropic_masked"]} class="text-xs text-base-content/50 mb-2">
              Current: {@api_form.params["anthropic_masked"]}
            </p>
            <input
              type="password"
              name="anthropic_api_key"
              placeholder="sk-ant-..."
              class="input-enterprise"
              autocomplete="off"
            />
          </div>

          <!-- Voyage -->
          <div>
            <div class="flex items-center justify-between mb-1.5">
              <label class="label-enterprise mb-0">Voyage AI API Key</label>
              <span :if={@api_form.params["voyage_configured"]} class="badge-success">Active</span>
            </div>
            <p :if={@api_form.params["voyage_masked"]} class="text-xs text-base-content/50 mb-2">
              Current: {@api_form.params["voyage_masked"]}
            </p>
            <input
              type="password"
              name="voyage_api_key"
              placeholder="pa-..."
              class="input-enterprise"
              autocomplete="off"
            />
            <div class="mt-3 p-3 bg-base-200/50">
              <div class="flex items-center justify-between text-sm">
                <span class="text-base-content/60">Token usage</span>
                <span class="text-base-content/80 font-medium">
                  {format_number(@app_settings.voyage_tokens_used || 0)} / {format_number(PdfTipsElixir.Settings.AppSetting.voyage_free_tier_tokens())}
                  ({PdfTipsElixir.Settings.AppSetting.voyage_usage_percentage(@app_settings)}%)
                </span>
              </div>
              <.progress_bar
                percentage={PdfTipsElixir.Settings.AppSetting.voyage_usage_percentage(@app_settings)}
                class="mt-2"
              />
              <div class="flex justify-end mt-2">
                <button
                  type="button"
                  phx-click="reset_voyage_tokens"
                  class="text-xs text-primary hover:text-primary/80"
                >
                  Reset counter
                </button>
              </div>
            </div>
          </div>

          <!-- Teams Integration -->
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <label class="label-enterprise mb-0 text-base">Microsoft Teams Integration</label>
              <%= if @api_form.params["integration_mode"] == :power_automate do %>
                <span class="badge-success">Power Automate</span>
              <% else %>
                <%= if @api_form.params["integration_mode"] == :webhook do %>
                  <span class="badge-warning">Webhook Only</span>
                <% end %>
              <% end %>
            </div>

            <!-- Power Automate URL (Recommended) -->
            <div class="p-4 bg-primary/5 border border-primary/20 rounded-lg">
              <div class="flex items-center justify-between mb-1.5">
                <label class="label-enterprise mb-0">Power Automate HTTP Trigger URL</label>
                <span :if={@api_form.params["power_automate_configured"]} class="badge-success text-xs">Active</span>
              </div>
              <p class="text-xs text-base-content/60 mb-2">
                Recommended: Posts to Teams AND creates MD file in SharePoint
              </p>
              <p :if={@api_form.params["power_automate_masked"]} class="text-xs text-base-content/50 mb-2">
                Current: {@api_form.params["power_automate_masked"]}
              </p>
              <input
                type="password"
                name="power_automate_url"
                placeholder="https://prod-xx.westus.logic.azure.com/..."
                class="input-enterprise"
                autocomplete="off"
              />
            </div>

            <!-- Teams Webhook URL (Fallback) -->
            <div class="p-4 bg-base-200/50 border border-base-300/50 rounded-lg">
              <div class="flex items-center justify-between mb-1.5">
                <label class="label-enterprise mb-0">Teams Webhook URL (Fallback)</label>
                <span :if={@api_form.params["teams_configured"] and not @api_form.params["power_automate_configured"]} class="badge-warning text-xs">Active</span>
                <span :if={@api_form.params["teams_configured"] and @api_form.params["power_automate_configured"]} class="badge-ghost text-xs">Backup</span>
              </div>
              <p class="text-xs text-base-content/60 mb-2">
                Direct webhook: Posts to Teams only (no SharePoint)
              </p>
              <p :if={@api_form.params["teams_masked"]} class="text-xs text-base-content/50 mb-2">
                Current: {@api_form.params["teams_masked"]}
              </p>
              <input
                type="password"
                name="teams_webhook_url"
                placeholder="https://..."
                class="input-enterprise"
                autocomplete="off"
              />
            </div>

            <!-- Test Connection Button -->
            <button
              :if={@api_form.params["teams_configured"] or @api_form.params["power_automate_configured"]}
              type="button"
              phx-click="test_teams"
              disabled={@testing_teams}
              class="text-sm text-primary hover:text-primary/80 disabled:opacity-50"
            >
              <%= if @testing_teams do %>
                <span class="flex items-center gap-1">
                  <.spinner class="w-3 h-3" />
                  Testing...
                </span>
              <% else %>
                Test Connection
              <% end %>
            </button>
          </div>

          <div class="pt-4 border-t border-base-300/50">
            <button type="submit" class="btn-enterprise-primary">
              Save API Keys
            </button>
          </div>
        </form>
      </.card>

      <!-- Embeddings Section -->
      <.card>
        <:header>
          <div class="flex items-center gap-3">
            <div class="p-2 bg-info/10">
              <.carbon_icon name="data-base" class="w-5 h-5 text-info" />
            </div>
            <div>
              <h2 class="font-medium text-base-content">Vector Embeddings</h2>
              <p class="text-sm text-base-content/50">Manage semantic search embeddings for your knowledge base</p>
            </div>
          </div>
        </:header>

        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-base-content">
                <span class="text-2xl font-semibold">{@embeddings_count}</span>
                <span class="text-base-content/60"> of </span>
                <span class="text-2xl font-semibold">{@chunks_count}</span>
                <span class="text-base-content/60"> chunks</span>
              </p>
              <p class="text-sm text-base-content/50 mt-1">have vector embeddings</p>
            </div>
            <button
              type="button"
              phx-click="refresh_embeddings_count"
              class="btn-enterprise-ghost"
            >
              <.carbon_icon name="refresh" class="w-4 h-4" />
              Refresh
            </button>
          </div>

          <.progress_bar
            :if={@chunks_count > 0}
            percentage={trunc(@embeddings_count / @chunks_count * 100)}
            class="h-2"
          />

          <%= if @api_form.params["voyage_configured"] do %>
            <%= if @embeddings_count < @chunks_count do %>
              <div class="pt-4 border-t border-base-300/50">
                <p class="text-sm text-base-content/60 mb-3">
                  Generate embeddings for all chunks without them. This enables semantic search for topic-based tip generation.
                </p>
                <button
                  type="button"
                  phx-click="generate_all_embeddings"
                  disabled={@generating_embeddings}
                  class="btn-enterprise-primary"
                >
                  <%= if @generating_embeddings do %>
                    <.spinner />
                    Generating in background...
                  <% else %>
                    Generate All Embeddings ({@chunks_count - @embeddings_count} remaining)
                  <% end %>
                </button>
                <p class="text-xs text-base-content/40 mt-2">
                  This runs in the background. Click refresh to check progress.
                </p>
              </div>
            <% else %>
              <div class="flex items-center gap-2 text-success pt-4 border-t border-base-300/50">
                <.carbon_icon name="checkmark-filled" class="w-5 h-5" />
                <span class="text-sm">All chunks have embeddings. Semantic search is fully enabled.</span>
              </div>
            <% end %>
          <% else %>
            <div class="flex items-center gap-2 text-warning pt-4 border-t border-base-300/50">
              <.carbon_icon name="warning" class="w-5 h-5" />
              <span class="text-sm">Configure your Voyage AI API key above to enable embedding generation.</span>
            </div>
          <% end %>
        </div>
      </.card>

      <!-- Schedule Section -->
      <.card>
        <:header>
          <div class="flex items-center gap-3">
            <div class="p-2 bg-accent/10">
              <.carbon_icon name="time" class="w-5 h-5 text-accent" />
            </div>
            <div>
              <h2 class="font-medium text-base-content">Scheduled Tip Generation</h2>
              <p class="text-sm text-base-content/50">Automatically generate and post tips on a schedule</p>
            </div>
          </div>
        </:header>

        <form phx-submit="save_schedule" phx-change="validate_schedule" class="space-y-5">
          <div class="flex items-center gap-3">
            <input
              type="checkbox"
              name="enabled"
              value="true"
              checked={@schedule_form.params["enabled"] == true or @schedule_form.params["enabled"] == "true"}
              class="w-4 h-4 rounded border-base-300 text-primary focus:ring-primary/30"
            />
            <label class="text-sm font-medium text-base-content">Enable scheduled tip generation</label>
          </div>

          <div>
            <label class="label-enterprise">Schedule</label>
            <select name="schedule" class="input-enterprise">
              <%= for schedule <- PdfTipsElixir.Scheduling.ScheduleSetting.schedules() do %>
                <option value={schedule} selected={@schedule_form.params["schedule"] == schedule}>
                  {PdfTipsElixir.Scheduling.ScheduleSetting.schedule_label(schedule)}
                </option>
              <% end %>
            </select>
          </div>

          <div>
            <label class="label-enterprise">Topic (optional)</label>
            <input
              type="text"
              name="topic"
              value={@schedule_form.params["topic"]}
              placeholder="e.g., prompt engineering, productivity"
              class="input-enterprise"
            />
            <p class="text-xs text-base-content/50 mt-1.5">
              If set, tips will be generated based on this topic using semantic search.
            </p>
          </div>

          <div class="pt-4 border-t border-base-300/50">
            <button type="submit" class="btn-enterprise-primary">
              Save Schedule
            </button>
          </div>

          <p :if={@schedule_settings.last_run_at} class="text-sm text-base-content/50">
            Last run: {format_datetime(@schedule_settings.last_run_at)}
          </p>
        </form>
      </.card>
    </div>

    <!-- Sidebar - Schedule Logs -->
    <div class="lg:col-span-1">
      <div class="card-enterprise sticky top-24">
        <div class="card-enterprise-header">
          <h2 class="font-medium text-base-content">Schedule Logs</h2>
        </div>
        <div class="card-enterprise-body">
          <%= if Enum.empty?(@logs) do %>
            <div class="text-center py-8">
              <.carbon_icon name="document" class="w-10 h-10 mx-auto text-base-content/20" />
              <p class="mt-3 text-sm text-base-content/50">No scheduled runs yet</p>
            </div>
          <% else %>
            <div class="space-y-2 max-h-[500px] overflow-y-auto">
              <%= for log <- @logs do %>
                <div class={["p-3 text-sm", log_bg_color(log.status)]}>
                  <div class="flex items-center justify-between">
                    <span class={["font-medium", log_text_color(log.status)]}>
                      {String.capitalize(log.status)}
                    </span>
                    <span class="text-xs text-base-content/50">
                      {format_relative_time(log.inserted_at)}
                    </span>
                  </div>
                  <p class="mt-1 text-base-content/70 text-xs">{log.message}</p>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
